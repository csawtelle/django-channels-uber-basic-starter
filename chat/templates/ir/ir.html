<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>{% block title %}Sensor Example{% endblock %}</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
	  {% load staticfiles%}
    <link rel="stylesheet" href="{% static 'css/chat.html' %}">
	</head>
	<body>
    <p>Hello {{username}}</p>
		<div class="container">
	    <div id="sensor">Sensor Reading: {{ reading }}</div>
		</div>
    <input type="text" id="sendMsg" onkeydown="if (event.keyCode == 13) {send(this.value); this.value='';}"/>
		<script src="//code.jquery.com/jquery-3.1.1.min.js"></script>
	</body>
</html>
<script>
  var socket = new WebSocket('ws://' + window.location.host);
  socket.onopen = function open() {
    console.log('WebSockets connection created.');
  };
  if (socket.readyState == WebSocket.OPEN) {
    socket.onopen();
  }

  function send(input) {
    var url = "http://idealistdesign.io/chat/send";
    $.ajax({
      url: url,
      type: "POST",
      data: {
        'producer': 'user1',
        'consumer': {{recipients|safe}},
        'message': input,
        'csrfmiddlewaretoken': '{{csrf_token}}'
      }
    }).done(function(response) {});
  }

  //You know.. for safety
  function strip(html) {
    var tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }

  $(function() {
    console.log("Javascript is working")
    // When we're using HTTPS, use WSS too.
    var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var chatsock = new WebSocket(ws_scheme + '://' + window.location.host);

    chatsock.onopen = function() {
      console.log("Connected!");
      $('#sensor').text("Connected!");
      chatsock.send("Connected!");
    };

    chatsock.onmessage = function(message) {
      console.log("Received Sock message!");
      console.log(message);
      $('#sensor').append("<p>"+strip(message.data)+"</p>");
    };
  });
</script>
